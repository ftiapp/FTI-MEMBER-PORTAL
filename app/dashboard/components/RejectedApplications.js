"use client";

import { useState, useEffect, useRef } from "react";
import { useRouter } from "next/navigation";
import { LoadingOverlay } from "./shared";

export default function RejectedApplications({
  currentPage = 1,
  itemsPerPage = 5,
  onPageChange,
  onTotalItemsChange,
}) {
  const [rejectedApps, setRejectedApps] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [totalItems, setTotalItems] = useState(0);
  const router = useRouter();

  // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô API calls ‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
  const fetchingRef = useRef(false);
  const lastFetchParamsRef = useRef(null);

  useEffect(() => {
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á unique key ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö fetch parameters
    const fetchKey = `${currentPage}-${itemsPerPage}`;

    // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á fetch ‡∏≠‡∏¢‡∏π‡πà ‡∏´‡∏£‡∏∑‡∏≠ parameters ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á fetch ‡πÉ‡∏´‡∏°‡πà
    if (fetchingRef.current || lastFetchParamsRef.current === fetchKey) {
      console.log("üö´ RejectedApplications - Skip duplicate fetch:", fetchKey);
      return;
    }

    console.log("‚úÖ RejectedApplications - Fetching with params:", { currentPage, itemsPerPage });
    lastFetchParamsRef.current = fetchKey;
    fetchRejectedApplications();
  }, [currentPage, itemsPerPage]);

  // ‡∏™‡πà‡∏á totalItems ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏´‡πâ parent component ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
  useEffect(() => {
    if (onTotalItemsChange) {
      onTotalItemsChange(totalItems);
    }
  }, [totalItems, onTotalItemsChange]);

  const fetchRejectedApplications = async () => {
    if (fetchingRef.current) {
      console.log("‚è≥ RejectedApplications - Already fetching, skipping...");
      return;
    }

    try {
      fetchingRef.current = true;
      setLoading(true);
      console.log("üì° RejectedApplications - API call starting (v2 - no Reject_DATA)...");
      const response = await fetch(`/api/membership/rejected-applications-v2`);
      const result = await response.json();

      console.log("üì• RejectedApplications - API response received:", {
        success: result.success,
        count: result.data?.length,
        totalItems: result.pagination?.totalItems || result.totalItems,
      });

      if (result.success) {
        setRejectedApps(result.data || []);
        setTotalItems(result.pagination?.totalItems || result.totalItems || 0);
      } else {
        setError(result.message || "Failed to fetch rejected applications");
        setRejectedApps([]);
        setTotalItems(0);
      }
    } catch (error) {
      console.error("‚ùå RejectedApplications - Error fetching:", error);
      setError("Failed to fetch rejected applications");
      setRejectedApps([]);
      setTotalItems(0);
    } finally {
      fetchingRef.current = false;
      setLoading(false);
      console.log("‚úÖ RejectedApplications - Fetch completed");
    }
  };

  const handleEditApplication = (app) => {
    // Navigate directly to the membership type specific edit form (v2 - uses Main table ID)
    const membershipType = app.membership_type; // v2 API returns 'membership_type'
    const editUrl = `/membership/${membershipType}/edit-rejected/${app.id}`;
    router.push(editUrl);
  };

  const handleCancelApplication = async (app) => {
    if (!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ô‡∏µ‡πâ? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ")) {
      return;
    }

    try {
      const response = await fetch(`/api/membership/rejected-applications/${app.id}`, {
        method: "DELETE",
      });

      const result = await response.json();

      if (result.success) {
        alert("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
        fetchRejectedApplications(); // Refresh the list
      } else {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + result.message);
      }
    } catch (error) {
      console.error("Error cancelling application:", error);
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£");
    }
  };

  const getMembershipTypeLabel = (type) => {
    const labels = {
      oc: "‡∏™‡∏≤‡∏°‡∏±‡∏ç-‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô (OC)",
      ac: "‡∏™‡∏°‡∏ó‡∏ö-‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (AC)",
      am: "‡∏™‡∏≤‡∏°‡∏±‡∏ç-‡∏™‡∏°‡∏≤‡∏Ñ‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ (AM)",
      ic: "‡∏™‡∏°‡∏ó‡∏ö-‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ (IC)",
    };
    return labels[type] || (type ? type.toUpperCase() : "N/A");
  };

  const formatDate = (dateString) => {
    if (!dateString) return "-";
    return new Date(dateString).toLocaleDateString("th-TH", {
      year: "numeric",
      month: "long",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    });
  };

  if (loading) {
    return <LoadingOverlay isVisible={true} message="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..." inline={true} />;
  }

  if (error) {
    return (
      <div className="text-center py-12">
        <div className="text-red-600 mb-4">
          <svg
            className="w-12 h-12 mx-auto mb-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
          <p className="text-lg font-medium">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>
          <p className="text-sm text-gray-600 mt-1">{error}</p>
        </div>
        <button
          onClick={fetchRejectedApplications}
          className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors"
        >
          ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
        </button>
      </div>
    );
  }

  if (rejectedApps.length === 0 && totalItems === 0) {
    return (
      <div className="text-center py-12">
        <div className="text-gray-400 mb-4">
          <svg
            className="w-16 h-16 mx-auto mb-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
            />
          </svg>
          <p className="text-lg font-medium text-gray-600">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</p>
          <p className="text-sm text-gray-500 mt-1">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {/* ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ */}
      {totalItems > 0 && (
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between text-sm text-gray-600 mb-4 gap-2">
          <span className="text-center sm:text-left">
            ‡πÅ‡∏™‡∏î‡∏á {Math.min((currentPage - 1) * itemsPerPage + 1, totalItems)}-
            {Math.min(currentPage * itemsPerPage, totalItems)} ‡∏à‡∏≤‡∏Å {totalItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
          </span>
          <span className="text-center sm:text-right text-gray-500">
            ‡∏´‡∏ô‡πâ‡∏≤ {currentPage} ‡∏à‡∏≤‡∏Å {Math.ceil(totalItems / itemsPerPage)}
          </span>
        </div>
      )}

      {/* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò */}
      {rejectedApps.map((app) => (
        <div
          key={app.id}
          className="bg-white border border-red-200 rounded-lg shadow-sm hover:shadow-md transition-shadow"
        >
          <div className="p-6">
            <div className="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
              <div className="flex-1">
                <div className="flex items-center space-x-3 mb-3">
                  <div className="flex items-center justify-center w-10 h-10 bg-red-100 rounded-full flex-shrink-0">
                    <svg
                      className="w-5 h-5 text-red-600"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                  </div>
                  <div>
                    <h3 className="text-lg font-semibold text-gray-900">
                      {app.application_name || "‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å"}
                    </h3>
                    <p className="text-sm text-gray-600">
                      {getMembershipTypeLabel(app.membership_type)}
                    </p>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <p className="text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß:</p>
                    <p className="text-sm text-gray-600">{app.identifier || "-"}</p>
                  </div>
                  <div>
                    <p className="text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò:</p>
                    <p className="text-sm text-gray-600">{formatDate(app.created_at)}</p>
                  </div>
                </div>

                {app.rejection_reason && (
                  <div className="mb-4">
                    <p className="text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò:</p>
                    <div className="bg-red-50 border border-red-200 rounded-md p-3">
                      <p className="text-sm text-red-800">{app.rejection_reason}</p>
                    </div>
                  </div>
                )}

                {/* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ */}
                {app.additional_notes && (
                  <div className="mb-4">
                    <p className="text-sm font-medium text-gray-700 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</p>
                    <div className="bg-gray-50 border border-gray-200 rounded-md p-3">
                      <p className="text-sm text-gray-600">{app.additional_notes}</p>
                    </div>
                  </div>
                )}
              </div>
            </div>

            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-end gap-3 pt-4 border-t border-gray-200">
              <button
                onClick={() => handleCancelApplication(app)}
                className="px-4 py-2 text-sm font-medium text-red-600 bg-white border border-red-300 rounded-md hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors w-full sm:w-auto"
              >
                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£
              </button>
              <button
                onClick={() => handleEditApplication(app)}
                className="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors w-full sm:w-auto"
              >
                ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà
              </button>
            </div>
          </div>
        </div>
      ))}

      {/* ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ß‡∏° */}
      {rejectedApps.length === 0 && totalItems > 0 && (
        <div className="text-center py-8 text-gray-500">
          <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</p>
          <button
            onClick={() => onPageChange && onPageChange(1)}
            className="mt-2 text-blue-600 hover:text-blue-800 underline"
          >
            ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
          </button>
        </div>
      )}
    </div>
  );
}
